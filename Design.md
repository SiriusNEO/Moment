# 设计大纲

## 框架适配

主要针对如 `miral/` 中的内容。

需要起码以下功能：

- 收发消息。
- 图片相关服务。

## 数据库

- 信息（cm）
- 用户（user）
- 别名（alias）

## 命令

### 特权级

- panic

  直接停止 bot。

### 用户级

收集一些有用的非数据库方面的命令。

- help

  显示帮助文档。

- choose

  使用方式是一个 python 的 list 加 choose 多少。如：

  ```
  [1, 2, 3] choose 2
  ```

  bot 会告诉你

  ```
  1 2
  ```
  
  你也可以使用如下类似 1d100 的方式
  
  ```
  [1:101] choose 1
  ```

### 数据库级

统一格式为：

```
new_header/index modify
```

其中 `new_header ` 包括：

- 不填，cm
- reg
- alias



new_header + modify 表示一个 new 事件。

只有 index 表示一个查询事件。

index + modify 表示一个修改事件。



#### 增加

- cm：直接 modify，可以直接加
- user：需要加前缀 reg
- alias：需要加前缀 alias

#### 查询

- cm：使用 `[]` 框起 index
- user：使用 `<>` 框起 index
- alias：使用 `{}` 

形式为：

`[key=233 ps=test]`

即不同 tag 间用空格分隔。

语法糖：

- 查询 id 时可以直接 `[id]`，注意 `[233 key=233]` 的情况。

- 查询某一个 tag：可以使用 `[index].tag_name` 形式。

  ```
  [id>6].key
  ```

  如果不止一个会输出所有的。想选择几个可以搭配 choose 使用。

  ```
  [id>6].key choose 1 #随机一个id>6数据的key值
  ```

目前支持查询：`= ? > <`，问号表示子串搜索，仅支持 msg 与 str 类型。

**查询过多只会显示一部分。**

#### 修改

先使用一个查询的头，再在后面跟上修改的内容。

目前支持：`= + -`

后两者只对部分 tag 有效。

**修改过多需要权限。**

**部分 tag 不支持修改 or 修改默认需要权限。**

特殊修改：`del`，`clr`，表示删除与清空。

### 其它

使用 `%this` 指代当前所引用的内容。

使用 `%pic` 匹配任意图片。

## 用户

用户的权限管理有：0（未注册），1（普通用户），2（特权用户）。

### 权限

一般有以下用到权限的地方：

- 对于 0 权的用户，机器人会**直接无视**其任何消息。

  0 权用户包括未使用 `reg` 注册的用户，以及其它同在群聊的机器人（请手动配置）。

- 修改大量信息需要特权（2）。

- 管理级命令需要特权（2）。

- 修改某些 tag 需要特权（2）。

  （如用户的 `priv`，所有数据的 `lock` 词条，`coin` 词条等）

- alias 需要特权（2）。

- 修改用户数据库中**其它用户**的任何信息需要特权（2）。

## 别名

计划设计一个带参的别名系统。目前仍在设计中。

## 简单的 Bot 功能示例实现

主要与 [Touhou-QQBot](https://github.com/SiriusNEO/Touhou-QQBot) 对比。为了证明 Moment 能做的更好。

- h

  帮助文档。Moment 中也会开发。

- r

  choose 可以代替一部分。以及可以通过数据库的方式代替。剩下的功能都比较花哨，砍掉。

- cm

  Moment 的强项。

- img

  Moment 的强项。Moment 选择将 cm 和 img 统一处理。

- al

  使用 time 这个 tag 来管理时间触发。

- as

  无用功能。爬虫徒增烦恼。砍。

- th

  可以考虑做成数据库内的数据。不过也算无用功能，砍。

- mod

  不是很有用。安静等要素可以修改 freq。

- 自发说话

  可以通过 act 这个 tag 管理信息自动说话。

  此外，Moment 还可以通过设定 `at_who` 或 `qt_who` 来指定当 @ 某人或者引用某人时说什么话。

- 复读

  吵。砍。